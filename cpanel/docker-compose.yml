version: "3"

services:
  reverse_proxy:
    env_file:
      - .env.production
      - .env.production.local
    container_name: regret_reverse_proxy
    hostname: regret_reverse_proxy
    image: nginx:alpine
    ports:
      - ${REVERSE_PROXY_EXPOSE_PORT}:80
    volumes:
      - ./docker/reverse_proxy/default.conf.template:/etc/nginx/conf.d/default.conf.template
      - ./docker/reverse_proxy/.htpasswd.template:/etc/nginx/.htpasswd.template
    command: >
      /bin/sh -c "
        envsubst '$$APP_EXPOSE_PORT' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf &&
        envsubst '$$BASIC_AUTH_USER $$BASIC_AUTH_PASSWORD' < /etc/nginx/.htpasswd.template > /etc/nginx/.htpasswd &&
        nginx -g 'daemon off;'"
    restart: always
    depends_on:
      - cpanel

  cpanel:
    container_name: regret_cpanel
    hostname: regret_cpanel
    build:
      context: .
      dockerfile: ./docker/cpanel/Dockerfile
    ports:
      - ${APP_EXPOSE_PORT}:3000
    restart: always

networks:
  default:
    name: regret_network
